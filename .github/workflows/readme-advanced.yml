name: Advanced Daily README Update

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch weather (Erode, IN)
        id: weather
        env:
          OWM_KEY: ${{ secrets.OWM_API_KEY }}
        run: |
          CITY="Erode,IN"
          URL="https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${OWM_KEY}&units=metric"
          RESP=$(curl -s "$URL")
          TEMP=$(jq -r '.main.temp' <<< "$RESP")
          DESC=$(jq -r '.weather[0].description' <<< "$RESP")
          HUMID=$(jq -r '.main.humidity' <<< "$RESP")
          echo "TEMP=$TEMP" >> $GITHUB_OUTPUT
          echo "DESC=$DESC" >> $GITHUB_OUTPUT
          echo "HUMID=$HUMID" >> $GITHUB_OUTPUT

      - name: Get daily quote
        id: quote
        run: |
          Q=$(curl -s "https://api.quotable.io/random" | jq -r '.content')
          echo "QUOTE=$Q" >> $GITHUB_OUTPUT

      - name: Local time (IST)
        id: ist
        run: |
          TIME=$(TZ="Asia/Kolkata" date +"%A, %d %B %Y %H:%M:%S %Z")
          echo "LOCAL_TIME=$TIME" >> $GITHUB_OUTPUT

      - name: Count today's commits (IST)
        id: commits
        run: |
          SINCE=$(TZ="Asia/Kolkata" date -d "today 00:00" --iso-8601=seconds)
          COUNT=$(git rev-list --count --since="$SINCE" HEAD)
          echo "COUNT=$COUNT" >> $GITHUB_OUTPUT

      - name: Prepare README section
        run: |
          TODAY=$(TZ="Asia/Kolkata" date +"%A, %d %B %Y")
          cat > section.md <<EOF
### ðŸ“… Date: **${TODAY}**
### ðŸ•’ Local Time (IST): **${{ steps.ist.outputs.LOCAL_TIME }}**

### â˜ï¸ Weather â€” Erode, India
- Temperature: **${{ steps.weather.outputs.TEMP }}Â°C**
- Condition: **${{ steps.weather.outputs.DESC }}**
- Humidity: **${{ steps.weather.outputs.HUMID }}%**

### ðŸ’¬ Quote of the Day
> _${{ steps.quote.outputs.QUOTE }}_

### ðŸ’ª Motivational message
> _You are improving daily â€” keep going._

### ðŸ“ˆ Repo Activity
- Commits today: **${{ steps.commits.outputs.COUNT }}**

![](https://img.shields.io/badge/Last_Update-${TODAY// /%20}-brightgreen?style=for-the-badge&logo=github)
EOF

      - name: Update README
        run: |
          START="<!--START_SECTION:daily_update-->"
          END="<!--END_SECTION:daily_update-->"
          awk -v s="$START" -v e="$END" -v r="$(sed 's/[\/&]/\\&/g' section.md)" '
            $0 ~ s {print; print r; skip=1; next}
            $0 ~ e {skip=0}
            skip==0 {print}
          ' README.md > README_new.md
          mv README_new.md README.md

      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸ”„ Advanced daily README update" || true
          git push
          
