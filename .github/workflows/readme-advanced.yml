name: Advanced Daily README Update

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch weather (Erode, IN)
        id: weather
        env:
          OWM_KEY: ${{ secrets.OWM_API_KEY }}
        run: |
          CITY="Erode,IN"
          URL="https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${OWM_KEY}&units=metric"
          RESP=$(curl -s "$URL")
          echo "TEMP=$(jq -r '.main.temp' <<< "$RESP")" >> $GITHUB_OUTPUT
          echo "DESC=$(jq -r '.weather[0].description' <<< "$RESP")" >> $GITHUB_OUTPUT
          echo "HUMID=$(jq -r '.main.humidity' <<< "$RESP")" >> $GITHUB_OUTPUT

      - name: Get daily quote
        id: quote
        run: |
          Q=$(curl -s "https://api.quotable.io/random" | jq -r '.content')
          echo "QUOTE=$Q" >> $GITHUB_OUTPUT

      - name: Local time (IST)
        id: ist
        run: |
          TIME=$(TZ="Asia/Kolkata" date +"%A, %d %B %Y %H:%M:%S %Z")
          echo "LOCAL_TIME=$TIME" >> $GITHUB_OUTPUT

      - name: Count commits today
        id: commits
        run: |
          SINCE=$(TZ="Asia/Kolkata" date -d "today 00:00" --iso-8601=seconds)
          COUNT=$(git rev-list --count --since="$SINCE" HEAD)
          echo "COUNT=$COUNT" >> $GITHUB_OUTPUT

      - name: Prepare README section
        run: |
          {
            echo "### ðŸ“… Date: **$(TZ='Asia/Kolkata' date '+%A, %d %B %Y')**"
            echo "### ðŸ•’ Local Time (IST): **${{ steps.ist.outputs.LOCAL_TIME }}**"
            echo ""
            echo "### â˜ï¸ Weather â€” Erode, India"
            echo "- Temperature: **${{ steps.weather.outputs.TEMP }}Â°C**"
            echo "- Condition: **${{ steps.weather.outputs.DESC }}**"
            echo "- Humidity: **${{ steps.weather.outputs.HUMID }}%**"
            echo ""
            echo "### ðŸ’¬ Quote of the Day"
            echo "> _${{ steps.quote.outputs.QUOTE }}_"
            echo ""
            echo "### ðŸ’ª Motivational Message"
            echo "> _Keep improving daily â€” success compounds!_"
            echo ""
            echo "### ðŸ“ˆ Repo Activity"
            echo "- Commits today: **${{ steps.commits.outputs.COUNT }}**"
            echo ""
            echo "![Last Update](https://img.shields.io/badge/Updated-$(date +%Y--%m--%d)-brightgreen?style=for-the-badge)"
          } > section.md

      - name: Update README
        run: |
          START="<!--START_SECTION:daily_update-->"
          END="<!--END_SECTION:daily_update-->"
          awk -v s="$START" -v e="$END" -v new="$(sed 's/[\/&]/\\&/g' section.md)" '
            $0 ~ s {print; print new; skip=1; next}
            $0 ~ e {skip=0}
            skip==0 {print}
          ' README.md > README_new.md
          mv README_new.md README.md

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Advanced daily README update" || true
          git push
